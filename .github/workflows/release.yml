name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    name: GoReleaser
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-formula:
    name: Update Homebrew Formula
    needs: goreleaser
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - name: Generate Formula
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          REPO="kubot64/gog-lite"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"

          get_sha256() {
            local file="$1"
            local url="${BASE_URL}/${file}"
            curl -sL "$url" | sha256sum | awk '{print $1}'
          }

          SHA_DARWIN_ARM64=$(get_sha256 "gog-lite_${VERSION}_darwin_arm64.tar.gz")
          SHA_DARWIN_AMD64=$(get_sha256 "gog-lite_${VERSION}_darwin_amd64.tar.gz")
          SHA_LINUX_ARM64=$(get_sha256 "gog-lite_${VERSION}_linux_arm64.tar.gz")
          SHA_LINUX_AMD64=$(get_sha256 "gog-lite_${VERSION}_linux_amd64.tar.gz")

          mkdir -p Formula
          cat > Formula/gog-lite.rb << RUBY
          class GogLite < Formula
            desc "CLI for AI agents to operate Gmail / Google Calendar / Google Docs"
            homepage "https://github.com/${REPO}"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/gog-lite_${VERSION}_darwin_arm64.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              else
                url "${BASE_URL}/gog-lite_${VERSION}_darwin_amd64.tar.gz"
                sha256 "${SHA_DARWIN_AMD64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
                url "${BASE_URL}/gog-lite_${VERSION}_linux_arm64.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "${BASE_URL}/gog-lite_${VERSION}_linux_amd64.tar.gz"
                sha256 "${SHA_LINUX_AMD64}"
              end
            end

            def install
              bin.install "gog-lite"
            end

            test do
              system "#{bin}/gog-lite", "--version"
            end
          end
          RUBY

          # Remove leading spaces from heredoc
          sed -i 's/^          //' Formula/gog-lite.rb
      - name: Commit and push Formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gog-lite.rb
          git commit -m "brew: update formula to ${GITHUB_REF_NAME}"
          git push
