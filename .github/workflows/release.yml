name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    name: Create CalVer Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.calver.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Calculate next CalVer tag
        id: calver
        run: |
          set -euo pipefail
          PREFIX="v$(date -u +%Y.%m)"
          LAST=$(git tag -l "${PREFIX}.*" --sort=-v:refname | head -n1)
          if [ -z "$LAST" ]; then
            PATCH=1
          else
            PATCH=$(( ${LAST##*.} + 1 ))
          fi
          TAG="${PREFIX}.${PATCH}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Next tag: ${TAG}"
      - name: Push tag
        run: |
          git tag "${{ steps.calver.outputs.tag }}"
          git push origin "${{ steps.calver.outputs.tag }}"

  goreleaser:
    name: GoReleaser
    needs: tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.tag.outputs.tag }}
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-formula:
    name: Update Homebrew Formula
    needs: [tag, goreleaser]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - name: Generate Formula
        run: |
          set -euo pipefail
          TAG="${{ needs.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          REPO="kubot64/gog-lite"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"

          get_sha256() {
            curl -sL "${BASE_URL}/$1" | sha256sum | awk '{print $1}'
          }

          SHA_DARWIN_ARM64=$(get_sha256 "gog-lite_${VERSION}_darwin_arm64.tar.gz")
          SHA_DARWIN_AMD64=$(get_sha256 "gog-lite_${VERSION}_darwin_amd64.tar.gz")
          SHA_LINUX_ARM64=$(get_sha256 "gog-lite_${VERSION}_linux_arm64.tar.gz")
          SHA_LINUX_AMD64=$(get_sha256 "gog-lite_${VERSION}_linux_amd64.tar.gz")

          mkdir -p Formula
          cat > Formula/gog-lite.rb <<RUBY
          class GogLite < Formula
            desc "CLI for AI agents to operate Gmail / Google Calendar / Google Docs"
            homepage "https://github.com/${REPO}"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/gog-lite_${VERSION}_darwin_arm64.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              else
                url "${BASE_URL}/gog-lite_${VERSION}_darwin_amd64.tar.gz"
                sha256 "${SHA_DARWIN_AMD64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
                url "${BASE_URL}/gog-lite_${VERSION}_linux_arm64.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "${BASE_URL}/gog-lite_${VERSION}_linux_amd64.tar.gz"
                sha256 "${SHA_LINUX_AMD64}"
              end
            end

            def install
              bin.install "gog-lite"
            end

            test do
              system "#{bin}/gog-lite", "--version"
            end
          end
          RUBY
          sed -i 's/^          //' Formula/gog-lite.rb
      - name: Commit and push Formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gog-lite.rb
          git commit -m "brew: update formula to ${{ needs.tag.outputs.tag }}"
          git push
