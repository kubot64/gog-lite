name: Tag Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    name: Create CalVer Tag
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate CalVer tag
        id: calver
        run: |
          set -euo pipefail
          TAG="v$(date -u +%Y.%m%d.%H%M)"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists. Wait a minute and retry."
            exit 1
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Tag: ${TAG}"
      - name: Push tag
        run: |
          git tag "${{ steps.calver.outputs.tag }}"
          git push origin "${{ steps.calver.outputs.tag }}"
